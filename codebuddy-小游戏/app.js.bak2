// ==================== æ•°æ®ç®¡ç† ====================
const Storage = {
    key: 'ai_playlab_v2',
    version: '4.0', // ç‰ˆæœ¬å·ï¼Œç”¨äºå¼ºåˆ¶æ›´æ–°
    
    get() {
        const data = localStorage.getItem(this.key);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                // æ£€æŸ¥ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬ä¸åŒ¹é…åˆ™é‡ç½®æ•°æ®
                if (parsed.version !== this.version) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œæ›´æ–°æ•°æ®...');
                    return this.getDefault();
                }
                return parsed;
            } catch (e) {
                return this.getDefault();
            }
        }
        return this.getDefault();
    },
    
    save(data) {
        data.version = this.version; // ä¿å­˜ç‰ˆæœ¬å·
        localStorage.setItem(this.key, JSON.stringify(data));
    },
    
    getDefault() {
        return {
            version: this.version,
            games: this.getDefaultGames(),
            userLikes: [],
            userComments: [],
            selectedAI: 'playlab'
        };
    },
    
    getDefaultGames() {
        return [
            {
                id: Date.now() - 1000000,
                title: 'æé¾™å¿«è·‘',
                author: 'AIåˆ›ä½œè€…',
                type: 'jump',
                thumbnail: 'https://images.unsplash.com/photo-1551808525-51a94da548ce?w=600&h=400&fit=crop',
                description: 'ç»å…¸çš„è·³è·ƒæ¸¸æˆï¼æ§åˆ¶å°æé¾™è·³è¿‡ä»™äººæŒéšœç¢ç‰©ï¼Œçœ‹ä½ èƒ½åšæŒå¤šä¹…ã€‚æŒ‰ç©ºæ ¼é”®è·³è·ƒï¼Œèº²é¿ä»™äººæŒï¼Œè·å–é«˜åˆ†ï¼',
                prompt: 'åˆ›å»ºä¸€ä¸ªå°æé¾™è·³è·ƒæ¸¸æˆï¼Œéœ€è¦èº²é¿ä»™äººæŒéšœç¢ç‰©ï¼ŒæŒ‰ç©ºæ ¼é”®è·³è·ƒ',
                aiModel: 'PlayLab AI',
                genTime: '3.2ç§’',
                likes: 1245,
                views: 8634,
                tags: ['ä¼‘é—²', 'è·³è·ƒ', 'æ— å°½æ¨¡å¼'],
                comments: [
                    { id: 1001, author: 'å°æ˜', content: 'å¤ªå¥½ç©äº†ï¼å·²ç»ç©äº†ä¸€ä¸ªå°æ—¶åœä¸ä¸‹æ¥ğŸ˜„', time: '11-12 14:32', replies: [] },
                    { id: 1002, author: 'æ¸¸æˆè¿·', content: 'è¿™ä¸ªæé¾™çš„é€ å‹å¥½å¯çˆ±ï¼Œè·³è·ƒæ‰‹æ„Ÿå¾ˆæ£’ï¼', time: '11-12 15:18', replies: [] },
                    { id: 1003, author: 'Coder007', content: 'AIç”Ÿæˆçš„æ¸¸æˆè´¨é‡è¿™ä¹ˆé«˜ï¼Ÿéœ‡æƒŠäº†ï¼', time: '11-12 16:45', replies: [] },
                    { id: 1004, author: 'ç©å®¶A', content: 'æ±‚æ•™å¤§ç¥æ€ä¹ˆè·³è¿‡è¿ç»­çš„ä»™äººæŒğŸŒµ', time: '11-12 18:20', replies: [
                        { author: 'æ¸¸æˆé«˜æ‰‹', content: 'å¤šç»ƒä¹ èŠ‚å¥ï¼Œæå‰èµ·è·³ï¼', time: '11-12 19:05' }
                    ]},
                    { id: 1005, author: 'å¤œçŒ«å­', content: 'åˆ·åˆ°200åˆ†äº†ï¼Œè¶Šæ¥è¶Šå¿«å¥½åˆºæ¿€ï¼', time: '11-13 01:15', replies: [] },
                    { id: 1006, author: 'ä¼‘é—²å…š', content: 'ä¸Šç­æ‘¸é±¼å¿…å¤‡ç¥å™¨å“ˆå“ˆå“ˆ', time: '11-13 10:30', replies: [
                        { author: 'è€æ¿', content: 'ï¼Ÿï¼Ÿï¼Ÿ', time: '11-13 10:31' }
                    ]}
                ],
                createdAt: Date.now() - 86400000 * 2
            },
            {
                id: Date.now() - 2000000,
                title: 'é£ç¿”å°é¸Ÿ',
                author: 'æ¸¸æˆå¤§å¸ˆ',
                type: 'fly',
                thumbnail: 'https://images.unsplash.com/photo-1444464666168-49d633b86797?w=600&h=400&fit=crop',
                description: 'ç‚¹å‡»ç”»å¸ƒè®©å°é¸Ÿé£èµ·æ¥ï¼Œç©¿è¿‡å±‚å±‚ç®¡é“éšœç¢ã€‚è€ƒéªŒä½ çš„ååº”é€Ÿåº¦å’ŒèŠ‚å¥æ„Ÿï¼',
                prompt: 'åˆ¶ä½œä¸€ä¸ªé£è¡Œæ¸¸æˆï¼Œå°é¸Ÿéœ€è¦ç©¿è¿‡ç®¡é“éšœç¢',
                aiModel: 'GPT-4',
                genTime: '4.1ç§’',
                likes: 982,
                views: 6421,
                tags: ['é£è¡Œ', 'æŠ€å·§', 'æŒ‘æˆ˜'],
                comments: [
                    { id: 2001, author: 'é£è¡Œå‘˜', content: 'æ¯”æ‰‹æœºä¸Šçš„åŸç‰ˆè¿˜æµç•…ï¼èŠ‚å¥æŒæ¡å¥½å°±èƒ½é£å¾ˆè¿œ', time: '11-10 09:12' },
                    { id: 2002, author: 'æ–°æ‰‹ç©å®¶', content: 'ç¬¬ä¸€æ¬¡ç©å°±æ’å¢™äº†ğŸ˜‚éœ€è¦å¤šç»ƒä¹ ', time: '11-10 14:25' },
                    { id: 2003, author: 'æŒ‘æˆ˜è€…', content: 'ç»ˆäºçªç ´50åˆ†å¤§å…³ï¼æ‰‹éƒ½ç‚¹é…¸äº†', time: '11-11 11:38' },
                    { id: 2004, author: 'è®¾è®¡å¸ˆ', content: 'å°é¸Ÿçš„åŠ¨ç”»æ•ˆæœåšå¾—çœŸä¸é”™ğŸ‘', time: '11-11 16:50' },
                    { id: 2005, author: 'å­¦ç”Ÿå…š', content: 'è¯¾é—´ååˆ†é’Ÿçš„å¿«ä¹æºæ³‰~', time: '11-12 10:05' }
                ],
                createdAt: Date.now() - 86400000 * 5
            },
            {
                id: Date.now() - 3000000,
                title: 'æ–¹å—æ¶ˆé™¤',
                author: 'åˆ›æ„ç©å®¶',
                type: 'match',
                thumbnail: 'https://images.unsplash.com/photo-1611996575749-79a3a250f948?w=600&h=400&fit=crop',
                description: 'ç‚¹å‡»ç›¸é‚»çš„æ–¹å—äº¤æ¢ä½ç½®ï¼Œå°†ä¸‰ä¸ªæˆ–æ›´å¤šç›¸åŒé¢œè‰²çš„æ–¹å—è¿æˆä¸€çº¿å³å¯æ¶ˆé™¤ï¼',
                prompt: 'åšä¸€ä¸ªæ¶ˆé™¤æ¸¸æˆï¼Œç‚¹å‡»ç›¸åŒé¢œè‰²çš„æ–¹å—å¯ä»¥æ¶ˆé™¤',
                aiModel: 'Claude',
                genTime: '3.8ç§’',
                likes: 756,
                views: 5123,
                tags: ['æ¶ˆé™¤', 'ç›Šæ™º', 'æ”¾æ¾'],
                comments: [
                    { id: 3001, author: 'ç›Šæ™ºçˆ±å¥½è€…', content: 'é…è‰²å¾ˆèˆ’æœï¼Œç©èµ·æ¥å¾ˆè§£å‹ğŸ’', time: '11-08 13:40' },
                    { id: 3002, author: 'Puzzle King', content: 'æ¶ˆé™¤éŸ³æ•ˆå¯ä»¥å†åŠ ä¸€ä¸‹å°±å®Œç¾äº†', time: '11-09 10:22' },
                    { id: 3003, author: 'ä¸Šç­æ—', content: 'åˆä¼‘æ—¶é—´çš„æœ€ä½³é€‰æ‹©ï¼Œä¸ç”¨æ€è€ƒå¤ªå¤š', time: '11-09 12:15' },
                    { id: 3004, author: 'æ¸¸æˆç­–åˆ’', content: 'å»ºè®®å¢åŠ è¿æ¶ˆå¥–åŠ±æœºåˆ¶ä¼šæ›´æœ‰è¶£', time: '11-10 15:33' },
                    { id: 3005, author: 'å½©è™¹æ§', content: 'è¿™ä¸ªé¢œè‰²æ­é…çˆ±äº†â¤ï¸', time: '11-11 08:47' },
                    { id: 3006, author: 'å¦ˆå¦ˆçº§ç©å®¶', content: 'ç®€å•æ˜“ä¸Šæ‰‹ï¼Œæ¨èç»™æœ‹å‹ä»¬äº†', time: '11-12 20:18' },
                    { id: 3007, author: 'æ¶ˆé™¤è¾¾äºº', content: 'ä¸€å±€èƒ½ç©åŠå°æ—¶ï¼Œå¤ªä¸Šç˜¾äº†', time: '11-13 09:25' }
                ],
                createdAt: Date.now() - 86400000 * 7
            },
            {
                id: Date.now() - 4000000,
                title: 'å¤ªç©ºå†’é™©',
                author: 'GameMaster',
                type: 'space',
                thumbnail: 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=600&h=400&fit=crop',
                description: 'é©¾é©¶å¤ªç©ºé£èˆ¹ï¼Œèº²é¿é™¨çŸ³å’Œéšœç¢ç‰©ï¼Œåœ¨æµ©ç€šæ˜Ÿç©ºä¸­å†’é™©ï¼æŒ‰ç©ºæ ¼é”®æ§åˆ¶é£èˆ¹é«˜åº¦ï¼',
                prompt: 'åˆ›å»ºä¸€ä¸ªå¤ªç©ºä¸»é¢˜çš„é£è¡Œæ¸¸æˆï¼Œèº²é¿é™¨çŸ³',
                aiModel: 'PlayLab AI',
                genTime: '3.5ç§’',
                likes: 634,
                views: 4215,
                tags: ['å¤ªç©º', 'å†’é™©', 'åŠ¨ä½œ'],
                comments: [
                    { id: 4001, author: 'æ˜Ÿé™…è¿·', content: 'å¤ªç©ºèƒŒæ™¯çš„æ˜Ÿæ˜Ÿæ•ˆæœå¤ªç¾äº†ğŸŒŸ', time: '11-05 16:28' },
                    { id: 4002, author: 'ç§‘å¹»ç²‰', content: 'é£èˆ¹çš„è®¾è®¡å¾ˆé…·ï¼å¼•æ“ç«ç„°çš„ç»†èŠ‚èµ', time: '11-06 11:45' },
                    { id: 4003, author: 'å†’é™©å®¶', content: 'é™¨çŸ³è¶Šæ¥è¶Šå¤šï¼ŒåæœŸéš¾åº¦å¤ŸåŠ²å„¿ï¼', time: '11-07 14:03' },
                    { id: 4004, author: 'å®‡èˆªå‘˜wannabe', content: 'ä»¿ä½›çœŸçš„åœ¨å¤ªç©ºé£è¡Œï¼Œæ²‰æµ¸æ„Ÿæ»¡åˆ†', time: '11-08 09:37' },
                    { id: 4005, author: 'SpaceXç²‰ä¸', content: 'å¸Œæœ›èƒ½åŠ å…¥æ›´å¤šå¤ªç©ºå…ƒç´ ï¼', time: '11-09 18:52' }
                ],
                createdAt: Date.now() - 86400000 * 10
            },
            {
                id: Date.now() - 5000000,
                title: 'å½©è™¹è¿çº¿',
                author: 'è‰ºæœ¯å®¶AI',
                type: 'connect',
                thumbnail: 'https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=600&h=400&fit=crop',
                description: 'æ‰¾å‡ºä¸¤ä¸ªç›¸åŒçš„å›¾æ¡ˆï¼Œç‚¹å‡»è¿çº¿æ¶ˆé™¤ï¼ç»å…¸çš„è¿è¿çœ‹ç©æ³•ï¼Œè½»æ¾åˆæœ‰è¶£ï¼',
                prompt: 'åšä¸€ä¸ªè¿è¿çœ‹æ¸¸æˆï¼Œç‚¹å‡»ç›¸åŒå›¾æ¡ˆè¿çº¿æ¶ˆé™¤',
                aiModel: 'Claude',
                genTime: '3.3ç§’',
                likes: 521,
                views: 3542,
                tags: ['è¿çº¿', 'ç›Šæ™º', 'ä¼‘é—²'],
                comments: [
                    { id: 5001, author: 'è®°å¿†å¤§å¸ˆ', content: 'å¾ˆå¥½çš„è®°å¿†åŠ›è®­ç»ƒæ¸¸æˆğŸ§ ', time: '11-03 10:15' },
                    { id: 5002, author: 'è€ç©å®¶', content: 'ç»å…¸è¿è¿çœ‹ç©æ³•ï¼Œæ‰¾åˆ°ç«¥å¹´çš„æ„Ÿè§‰äº†', time: '11-04 15:42' },
                    { id: 5003, author: 'Emojiæ§', content: 'å›¾æ¡ˆé€‰æ‹©å¾ˆå¯çˆ±ï¼ŒèŠ±èŠ±è‰è‰çš„ğŸŒ¸', time: '11-05 12:28' },
                    { id: 5004, author: 'ç›Šæ™ºæ¸¸æˆè¿·', content: 'å»ºè®®åŠ ä¸ªè®¡æ—¶æ¨¡å¼å¢åŠ æŒ‘æˆ˜æ€§', time: '11-06 16:33' },
                    { id: 5005, author: 'ä¼‘é—²ç©å®¶', content: 'ä¸ç”¨ç€æ€¥æ…¢æ…¢ç©ï¼Œå¾ˆæ”¾æ¾', time: '11-07 20:17' },
                    { id: 5006, author: 'çœ¼åŠ›é«˜æ‰‹', content: 'å…¨æ¶ˆé™¤çš„æˆå°±æ„Ÿå¤ªçˆ½äº†ï¼', time: '11-08 11:05' },
                    { id: 5007, author: 'ä¸Šç­æ‘¸é±¼', content: 'é¢†å¯¼æ¥äº†ä¹Ÿèƒ½è£…ä½œåœ¨æ€è€ƒğŸ˜', time: '11-09 14:48' },
                    { id: 5008, author: 'é…è‰²è¾¾äºº', content: 'ç´«è‰²èƒŒæ™¯é…å½©è‰²å›¾æ¡ˆå¾ˆå’Œè°', time: '11-10 09:23' }
                ],
                createdAt: Date.now() - 86400000 * 12
            },
            {
                id: Date.now() - 6000000,
                title: 'æé€Ÿè·‘é…·',
                author: 'å†’é™©å®¶',
                type: 'parkour',
                thumbnail: 'https://images.unsplash.com/photo-1461897104016-0b3b00cc81ee?w=600&h=400&fit=crop',
                description: 'åœ¨åŸå¸‚å±‹é¡¶é—´è·³è·ƒï¼Œæ”¶é›†é‡‘å¸ï¼Œèº²é¿éšœç¢ï¼ŒæŒ‘æˆ˜ä½ çš„æé™ååº”ï¼',
                prompt: 'åˆ¶ä½œè·‘é…·æ¸¸æˆï¼Œè§’è‰²åœ¨å±‹é¡¶è·³è·ƒæ”¶é›†é‡‘å¸',
                aiModel: 'GPT-4',
                genTime: '4.2ç§’',
                likes: 445,
                views: 2987,
                tags: ['è·‘é…·', 'åŠ¨ä½œ', 'æŒ‘æˆ˜'],
                comments: [
                    { id: 6001, author: 'è·‘é…·è¾¾äºº', content: 'è·³è·ƒæ‰‹æ„Ÿå¾ˆçˆ½å¿«ï¼èŠ‚å¥æ„Ÿå¼ºğŸ’ª', time: '10-31 13:27' },
                    { id: 6002, author: 'é‡‘å¸æ”¶é›†ç‹‚', content: 'ä¸€å±€æ”¶é›†äº†50ä¸ªé‡‘å¸ï¼Œçˆ½ï¼', time: '11-01 16:09' },
                    { id: 6003, author: 'æé™ç©å®¶', content: 'éšœç¢è®¾è®¡åˆç†ï¼Œéœ€è¦ç²¾å‡†æ“ä½œ', time: '11-02 10:44' },
                    { id: 6004, author: 'åŠ¨ä½œæ¸¸æˆç²‰', content: 'å¤©ç©ºæ¸å˜è‰²èƒŒæ™¯å¥½çœ‹ğŸ˜', time: '11-03 14:56' },
                    { id: 6005, author: 'æ‰‹æ®‹å…š', content: 'éš¾åº¦æœ‰ç‚¹é«˜ï¼Œä½†å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼', time: '11-04 11:32' },
                    { id: 6006, author: 'é«˜åˆ†æŒ‘æˆ˜è€…', content: 'å·²ç»åˆ·åˆ°300åˆ†äº†è¿˜æƒ³ç»§ç»­ï¼', time: '11-05 19:21' }
                ],
                createdAt: Date.now() - 86400000 * 15
            }
        ];
    }
};

// å…¨å±€çŠ¶æ€
let appData = Storage.get();
let currentGame = null;
let currentGameEngine = null;
let currentFilter = 'all';
let currentView = 'all'; // 'all' æˆ– 'mine'
let currentRanking = 'daily';
let selectedAI = appData.selectedAI || 'playlab';

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', () => {
    renderGameGallery();
    renderRanking(currentRanking);
    updateMyGamesCount();
    console.log('ğŸ® AI PlayLab å·²å¯åŠ¨ï¼');
});

// ==================== æ¸¸æˆç”»å»Š ====================
function renderGameGallery() {
    const grid = document.getElementById('gameGrid');
    const emptyState = document.getElementById('emptyState');
    
    let games = appData.games;
    
    // æ ¹æ®è§†å›¾ç­›é€‰
    if (currentView === 'mine') {
        games = games.filter(g => g.author === 'æˆ‘');
    }
    
    // æ ¹æ®ç±»å‹ç­›é€‰
    if (currentFilter !== 'all') {
        games = games.filter(g => g.type === currentFilter);
    }
    
    // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
    if (games.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        
        if (currentView === 'mine') {
            emptyState.querySelector('.empty-title').textContent = 'è¿˜æ²¡æœ‰åˆ›ä½œä½œå“';
            emptyState.querySelector('.empty-desc').textContent = 'ç‚¹å‡»"åˆ›ä½œæ¸¸æˆ"æŒ‰é’®ï¼Œç”¨AIåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªæ¸¸æˆå§ï¼';
        } else {
            emptyState.querySelector('.empty-title').textContent = 'æš‚æ— æ¸¸æˆ';
            emptyState.querySelector('.empty-desc').textContent = 'è¯¥åˆ†ç±»ä¸‹è¿˜æ²¡æœ‰æ¸¸æˆä½œå“';
        }
        return;
    }
    
    grid.style.display = 'grid';
    emptyState.style.display = 'none';
    
    grid.innerHTML = games.map(game => `
        <div class="game-card">
            <div class="game-thumbnail" onclick="openGame(${game.id})">
                <img src="${game.thumbnail}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%232a2a3a%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2264%22 text-anchor=%22middle%22 dy=%22.3em%22%3E${getGameIcon(game.type)}%3C/text%3E%3C/svg%3E';">
                <div class="card-hover-overlay">
                    <button class="btn-quick-play" onclick="event.stopPropagation(); openGame(${game.id})">
                        <span class="icon">â–¶</span>
                        <span>å¿«é€Ÿè¯•ç©</span>
                    </button>
                </div>
            </div>
            <div class="game-info">
                <div class="game-header-row" onclick="openGame(${game.id})">
                    <h3 class="game-title">${game.title}</h3>
                    <p class="game-author">ğŸ‘¤ ${game.author}</p>
                </div>
                
                <div class="game-prompt-preview">
                    <span class="prompt-label">ğŸ’­</span>
                    <span class="prompt-text">${game.prompt}</span>
                </div>
                
                <div class="game-actions">
                    <div class="game-stats">
                        <span class="stat-likes">â¤ï¸ ${game.likes}</span>
                        <span class="stat-comments" onclick="event.stopPropagation(); openGameComments(${game.id})">ğŸ’¬ ${game.comments.length}</span>
                    </div>
                    <button class="btn-remix-mini" onclick="event.stopPropagation(); remixGameFromCard(${game.id})" title="åŸºäºæ­¤æ¸¸æˆè¿›è¡ŒäºŒåˆ›">
                        <span class="icon">ğŸ¨</span>
                        <span>Remix</span>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function getGameIcon(type) {
    const icons = {
        'jump': 'ğŸ¦–',
        'fly': 'ğŸ¦',
        'match': 'ğŸ’'
    };
    return icons[type] || 'ğŸ®';
}

// åˆ‡æ¢ç”»å»Šè§†å›¾
function switchGalleryView(view) {
    currentView = view;
    currentFilter = 'all';
    
    // æ›´æ–°è§†å›¾æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.gallery-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.gallery-tab').classList.add('active');
    
    // é‡ç½®ç­›é€‰æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.filter-btn').classList.add('active');
    
    renderGameGallery();
}

function filterGames(type) {
    currentFilter = type;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderGameGallery();
}

// è·å–æˆ‘çš„æ¸¸æˆ
function getMyGames() {
    return appData.games.filter(g => g.author === 'æˆ‘');
}

// æ›´æ–°"æˆ‘çš„ä½œå“"æ•°é‡
function updateMyGamesCount() {
    const count = getMyGames().length;
    document.getElementById('myGamesCount').textContent = count;
}

// ==================== æ’è¡Œæ¦œ ====================
function renderRanking(timeframe) {
    const now = Date.now();
    const timeRanges = {
        'daily': 86400000,
        'weekly': 604800000,
        'monthly': 2592000000
    };
    
    const timeLimit = now - (timeRanges[timeframe] || timeRanges['daily']);
    const rankedGames = appData.games
        .filter(g => g.createdAt >= timeLimit)
        .sort((a, b) => b.likes - a.likes)
        .slice(0, 10);
    
    const list = document.getElementById('rankingList');
    
    if (rankedGames.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">æš‚æ— æ•°æ®</p>';
        return;
    }
    
    list.innerHTML = rankedGames.map((game, index) => {
        const rank = index + 1;
        const rankClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : '';
        const rankSymbol = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
        
        return `
            <div class="rank-item" onclick="openGame(${game.id})">
                <div class="rank-number ${rankClass}">${rankSymbol}</div>
                <div class="rank-info">
                    <div class="rank-game-title">${game.title}</div>
                    <div class="rank-game-author">by ${game.author}</div>
                </div>
                <div class="rank-score">${game.likes}ğŸ”¥</div>
            </div>
        `;
    }).join('');
}

function switchRanking(timeframe) {
    currentRanking = timeframe;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.rank-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderRanking(timeframe);
}

// ==================== åˆ›ä½œå¼¹çª— ====================
function openCreator() {
    document.getElementById('creatorModal').classList.add('active');
}

function closeCreator() {
    document.getElementById('creatorModal').classList.remove('active');
}

function setPrompt(text) {
    document.getElementById('gamePrompt').value = text;
}

function selectAI(model) {
    selectedAI = model;
    appData.selectedAI = model;
    Storage.save(appData);
    
    // æ›´æ–°UI
    document.querySelectorAll('.model-card').forEach(card => {
        card.classList.remove('active');
    });
    document.querySelector(`.model-card[data-model="${model}"]`).classList.add('active');
}

// ==================== AIç”Ÿæˆæ¸¸æˆ ====================
function generateGame() {
    const prompt = document.getElementById('gamePrompt').value.trim();
    
    if (!prompt) {
        alert('è¯·è¾“å…¥æ¸¸æˆåˆ›æ„ï¼');
        return;
    }
    
    closeCreator();
    showLoading();
    
    // æ¨¡æ‹ŸAIç”Ÿæˆ
    simulateGeneration(prompt);
}

function showLoading() {
    const modal = document.getElementById('loadingModal');
    modal.classList.add('active');
    
    const statusEl = document.getElementById('loadingStatus');
    const progressEl = document.getElementById('progressFill');
    
    const steps = [
        'åˆ†ææ‚¨çš„åˆ›æ„...',
        'AIæ­£åœ¨è®¾è®¡æ¸¸æˆæœºåˆ¶...',
        'ç”Ÿæˆæ¸¸æˆç¾æœ¯èµ„æº...',
        'ç¼–è¯‘æ¸¸æˆä»£ç ...',
        'æ¸¸æˆç”Ÿæˆå®Œæˆï¼'
    ];
    
    let step = 0;
    const interval = setInterval(() => {
        if (step < steps.length) {
            statusEl.textContent = steps[step];
            progressEl.style.width = ((step + 1) / steps.length * 100) + '%';
            step++;
        }
    }, 800);
    
    setTimeout(() => {
        clearInterval(interval);
        modal.classList.remove('active');
    }, 4000);
}

function simulateGeneration(prompt) {
    setTimeout(() => {
        const newGame = createGameFromPrompt(prompt);
        appData.games.unshift(newGame);
        Storage.save(appData);
        
        // æ›´æ–°æˆ‘çš„ä½œå“æ•°é‡
        updateMyGamesCount();
        
        renderGameGallery();
        renderRanking(currentRanking);
        
        // è‡ªåŠ¨æ‰“å¼€æ–°æ¸¸æˆ
        openGame(newGame.id);
    }, 4200);
}

function createGameFromPrompt(prompt) {
    let type = 'jump';
    let title = 'æˆ‘çš„æ¸¸æˆ';
    let tags = ['AIç”Ÿæˆ', 'åŸåˆ›'];
    let thumbnail = null;
    let character = null; // è§’è‰²ç±»å‹
    let customDescription = prompt;
    
    // è¯†åˆ«è§’è‰²ç±»å‹
    if (prompt.match(/çŒ«|å°çŒ«|å–µ/)) {
        character = 'cat';
        tags.push('çŒ«å’ª');
    } else if (prompt.match(/ç‹—|å°ç‹—|æ±ª/)) {
        character = 'dog';
        tags.push('å°ç‹—');
    } else if (prompt.match(/å…”|å…”å­/)) {
        character = 'rabbit';
        tags.push('å…”å­');
    } else if (prompt.match(/æé¾™/)) {
        character = 'dino';
    } else if (prompt.match(/é¸Ÿ|å°é¸Ÿ/)) {
        character = 'bird';
    }
    
    // å…³é”®è¯åŒ¹é…æ¸¸æˆç±»å‹ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰
    // å¦å…‹å®ˆå®¶ç±»ï¼ˆæœ€ä¼˜å…ˆï¼‰
    if (prompt.match(/å¦å…‹|å®ˆå®¶|é˜²å¾¡|å¡”é˜²|å®ˆå«|åŸºåœ°/)) {
        type = 'tank';
        title = 'å¦å…‹å®ˆå®¶ ' + Date.now().toString().slice(-4);
        tags.push('ç­–ç•¥', 'é˜²å¾¡');
        thumbnail = 'https://images.unsplash.com/photo-1614680376573-df3480f0c6ff?w=600&h=400&fit=crop';
        
    // é£æœºå¤§æˆ˜ç±»
    } else if (prompt.match(/é£æœºå¤§æˆ˜|æ‰“é£æœº|å°„å‡»|æˆ˜æœº|ç©ºæˆ˜|å­å¼¹|æ•Œæœº/)) {
        type = 'shoot';
        title = 'é£æœºå¤§æˆ˜ ' + Date.now().toString().slice(-4);
        tags.push('å°„å‡»', 'åŠ¨ä½œ');
        thumbnail = 'https://images.unsplash.com/photo-1569003339405-ea396a5a8a90?w=600&h=400&fit=crop';
        
    } else if (prompt.match(/è·³|æé¾™|èº²é¿|çŒ«.*è·³|ç‹—.*è·³|å…”.*è·³/)) {
        type = 'jump';
        
        // æ ¹æ®è§’è‰²ç”Ÿæˆæ ‡é¢˜å’Œç¼©ç•¥å›¾
        if (character === 'cat') {
            title = 'çŒ«å’ªè·‘é…· ' + Date.now().toString().slice(-4);
            thumbnail = 'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=600&h=400&fit=crop';
        } else if (character === 'dog') {
            title = 'å°ç‹—å¿«è·‘ ' + Date.now().toString().slice(-4);
            thumbnail = 'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=600&h=400&fit=crop';
        } else if (character === 'rabbit') {
            title = 'å…”å­è·³è·³ ' + Date.now().toString().slice(-4);
            thumbnail = 'https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?w=600&h=400&fit=crop';
        } else {
            title = 'è·³è·ƒå†’é™© ' + Date.now().toString().slice(-4);
            thumbnail = 'https://images.unsplash.com/photo-1551808525-51a94da548ce?w=600&h=400&fit=crop';
        }
        tags.push('è·³è·ƒ');
        
    } else if (prompt.match(/é£|é¸Ÿ|ç®¡é“|ç¿…è†€/)) {
        type = 'fly';
        title = 'é£è¡ŒæŒ‘æˆ˜ ' + Date.now().toString().slice(-4);
        tags.push('é£è¡Œ');
        thumbnail = 'https://images.unsplash.com/photo-1444464666168-49d633b86797?w=600&h=400&fit=crop';
        
    } else if (prompt.match(/æ¶ˆé™¤|æ–¹å—|åŒ¹é…/)) {
        type = 'match';
        title = 'æ¶ˆé™¤ä¹å›­ ' + Date.now().toString().slice(-4);
        tags.push('æ¶ˆé™¤');
        thumbnail = 'https://images.unsplash.com/photo-1611996575749-79a3a250f948?w=600&h=400&fit=crop';
        
    } else if (prompt.match(/å¤ªç©º|é£èˆ¹|é™¨çŸ³|æ˜Ÿç©º/)) {
        type = 'space';
        title = 'å¤ªç©ºä¹‹æ—… ' + Date.now().toString().slice(-4);
        tags.push('å¤ªç©º');
        thumbnail = 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=600&h=400&fit=crop';
        
    } else if (prompt.match(/è¿è¿çœ‹|è¿çº¿|é…å¯¹/)) {
        type = 'connect';
        title = 'è¶£å‘³è¿çº¿ ' + Date.now().toString().slice(-4);
        tags.push('è¿çº¿');
        thumbnail = 'https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=600&h=400&fit=crop';
        
    } else if (prompt.match(/è·‘é…·|é‡‘å¸|å±‹é¡¶/)) {
        type = 'parkour';
        title = 'æé™è·‘é…· ' + Date.now().toString().slice(-4);
        tags.push('è·‘é…·');
        thumbnail = 'https://images.unsplash.com/photo-1461897104016-0b3b00cc81ee?w=600&h=400&fit=crop';
    }
    
    const modelNames = {
        'playlab': 'PlayLab AI',
        'gpt4': 'GPT-4',
        'claude': 'Claude'
    };
    
    return {
        id: Date.now(),
        title,
        author: 'æˆ‘',
        type,
        thumbnail,
        description: customDescription,
        prompt,
        aiModel: modelNames[selectedAI],
        genTime: (Math.random() * 2 + 2).toFixed(1) + 'ç§’',
        likes: 0,
        views: 0,
        tags,
        comments: [],
        createdAt: Date.now(),
        character: character || 'default' // ä¿å­˜è§’è‰²ä¿¡æ¯ä¾›æ¸¸æˆå¼•æ“ä½¿ç”¨
    };
}

// ä»å¡ç‰‡å¿«é€Ÿæ‰“å¼€è¯„è®ºåŒº
function openGameComments(gameId) {
    openGame(gameId);
    setTimeout(() => {
        switchTab('comments');
        document.getElementById('commentInput').focus();
    }, 100);
}

// ä»å¡ç‰‡å¿«é€ŸRemix
function remixGameFromCard(gameId) {
    const game = appData.games.find(g => g.id === gameId);
    if (!game) return;
    
    openCreator();
    const remixPrompt = `${game.prompt}\n\nï¼ˆåŸºäº @${game.author} çš„ã€Š${game.title}ã€‹è¿›è¡ŒäºŒåˆ›ï¼‰`;
    document.getElementById('gamePrompt').value = remixPrompt;
}

// ==================== æ¸¸æˆè¯¦æƒ… ====================
function openGame(gameId) {
    const game = appData.games.find(g => g.id === gameId);
    if (!game) return;
    
    currentGame = game;
    game.views++;
    Storage.save(appData);
    
    // å¡«å……æ•°æ®
    document.getElementById('modalGameTitle').textContent = game.title;
    document.getElementById('modalGameAuthor').textContent = game.author;
    document.getElementById('modalGameViews').textContent = game.views;
    document.getElementById('gameDescription').textContent = game.description;
    document.getElementById('displayPrompt').textContent = game.prompt;
    document.getElementById('aiModelUsed').textContent = game.aiModel;
    document.getElementById('genTime').textContent = game.genTime;
    document.getElementById('gameScore').textContent = '0';
    
    // æ ‡ç­¾
    document.getElementById('gameTags').innerHTML = game.tags
        .map(tag => `<span class="game-tag">#${tag}</span>`)
        .join('');
    
    // ç‚¹èµçŠ¶æ€
    const isLiked = appData.userLikes.includes(gameId);
    document.getElementById('likeIcon').textContent = isLiked ? 'â¤ï¸' : 'ğŸ¤';
    document.getElementById('likeText').textContent = isLiked ? 'å·²èµ' : 'ç‚¹èµ';
    document.getElementById('likeCount').textContent = game.likes;
    document.getElementById('likeBtn').classList.toggle('liked', isLiked);
    
    // è¯„è®ºæ•°
    const totalComments = game.comments.length + game.comments.reduce((sum, c) => sum + (c.replies ? c.replies.length : 0), 0);
    document.getElementById('commentCountBtn').textContent = totalComments;
    
    // éšæœºå¹¿å‘Šæ•°æ®
    const ads = [
        { title: 'è…¾è®¯äº‘æœåŠ¡å™¨', desc: 'æ–°ç”¨æˆ·ä¸“äº«ä¼˜æƒ ', cta: 'ç«‹å³æŠ¢è´­', img: 'â˜ï¸' },
        { title: 'AI ç¼–ç¨‹åŠ©æ‰‹', desc: 'æå‡å¼€å‘æ•ˆç‡10å€', cta: 'å…è´¹è¯•ç”¨', img: 'ğŸ¤–' },
        { title: 'æ¸¸æˆè®¾è®¡è¯¾ç¨‹', desc: 'ä»é›¶å¼€å§‹å­¦æ¸¸æˆå¼€å‘', cta: 'ç«‹å³æŠ¥å', img: 'ğŸ®' },
        { title: 'ä¸“ä¸šç¾æœ¯èµ„æº', desc: 'æµ·é‡ç´ æä»»ä½ ç”¨', cta: 'æŸ¥çœ‹è¯¦æƒ…', img: 'ğŸ¨' },
        { title: 'Unity Pro æˆæƒ', desc: 'é™æ—¶ä¼˜æƒ 8æŠ˜', cta: 'ç«‹å³è´­ä¹°', img: 'ğŸš€' },
        { title: 'æœåŠ¡å™¨æ‰˜ç®¡', desc: 'ç¨³å®šé«˜é€Ÿï¼Œ99.99%å¯ç”¨', cta: 'äº†è§£æ›´å¤š', img: 'ğŸ’»' }
    ];
    const randomAd = ads[Math.floor(Math.random() * ads.length)];
    
    document.querySelector('.ad-content').innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 40px; margin-bottom: 10px;">${randomAd.img}</div>
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #fff;">${randomAd.title}</div>
            <div style="font-size: 13px; color: #a0a0a0; margin-bottom: 15px;">${randomAd.desc}</div>
            <button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           color: white; border: none; padding: 8px 20px; border-radius: 20px; 
                           cursor: pointer; font-size: 13px;">${randomAd.cta}</button>
        </div>
    `;
    document.getElementById('adViews').textContent = game.views;
    const revenue = (game.views / 1000 * (Math.random() * 10 + 5)).toFixed(2);
    document.getElementById('adRevenue').textContent = 'Â¥' + revenue;
    
    // æ˜¾ç¤º/éšè—åˆ é™¤æŒ‰é’®
    const deleteBtn = document.getElementById('deleteGameBtn');
    if (game.author === 'æˆ‘') {
        if (!deleteBtn) {
            const remixBtn = document.querySelector('.btn-remix');
            const delBtn = document.createElement('button');
            delBtn.id = 'deleteGameBtn';
            delBtn.className = 'btn-remix';
            delBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            delBtn.innerHTML = 'ğŸ—‘ï¸ åˆ é™¤æ¸¸æˆ';
            delBtn.onclick = () => deleteGame(gameId);
            remixBtn.parentNode.insertBefore(delBtn, remixBtn.nextSibling);
        }
    } else if (deleteBtn) {
        deleteBtn.remove();
    }
    
    // æ¸²æŸ“è¯„è®º
    renderComments();
    
    // é‡ç½®æ ‡ç­¾é¡µ
    switchTab('info');
    
    // åˆå§‹åŒ–æ¸¸æˆ
    initGameEngine(game.type, game.character);
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('gameModal').classList.add('active');
}

function closeGameModal() {
    document.getElementById('gameModal').classList.remove('active');
    if (currentGameEngine) {
        currentGameEngine.stop();
        currentGameEngine = null;
    }
}

// ==================== æ¸¸æˆå¼•æ“ ====================
function initGameEngine(type, character) {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // åœæ­¢ä¹‹å‰çš„æ¸¸æˆ
    if (currentGameEngine) {
        currentGameEngine.stop();
    }
    
    // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®
    document.getElementById('gameOverlay').classList.remove('hidden');
    
    // æ ¹æ®ç±»å‹åˆ›å»ºæ¸¸æˆ
    if (type === 'jump') {
        currentGameEngine = new DinoGame(canvas, ctx, character);
    } else if (type === 'fly') {
        currentGameEngine = new BirdGame(canvas, ctx);
    } else if (type === 'match') {
        currentGameEngine = new MatchGame(canvas, ctx);
    } else if (type === 'space') {
        currentGameEngine = new SpaceGame(canvas, ctx);
    } else if (type === 'connect') {
        currentGameEngine = new ConnectGame(canvas, ctx);
    } else if (type === 'parkour') {
        currentGameEngine = new ParkourGame(canvas, ctx);
    } else if (type === 'shoot') {
        currentGameEngine = new ShootGame(canvas, ctx);
    } else if (type === 'tank') {
        currentGameEngine = new TankGame(canvas, ctx);
    }
}

function startGamePlay() {
    if (currentGameEngine) {
        document.getElementById('gameOverlay').classList.add('hidden');
        currentGameEngine.start();
    }
}

// æé¾™è·³è·ƒæ¸¸æˆ
class DinoGame {
    constructor(canvas, ctx, character) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        this.character = character || 'dino'; // é»˜è®¤æé¾™
        
        this.dino = {
            x: 100,
            y: 350,
            width: 40,
            height: 50,
            velocityY: 0,
            jumping: false
        };
        
        this.obstacles = [];
        this.gravity = 0.8;
        this.jumpPower = -15;
        this.speed = 5;
        this.frame = 0;
        
        this.keyHandler = (e) => {
            if (e.code === 'Space' && !this.dino.jumping && this.running) {
                this.jump();
                e.preventDefault();
            }
        };
        
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.obstacles = [];
        this.dino.y = 350;
        this.dino.velocityY = 0;
        this.dino.jumping = false;
        document.addEventListener('keydown', this.keyHandler);
        this.gameLoop();
    }
    
    stop() {
        this.running = false;
        document.removeEventListener('keydown', this.keyHandler);
    }
    
    jump() {
        if (!this.dino.jumping) {
            this.dino.velocityY = this.jumpPower;
            this.dino.jumping = true;
        }
    }
    
    gameLoop() {
        if (!this.running) return;
        
        this.update();
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    update() {
        this.frame++;
        this.score++;
        document.getElementById('gameScore').textContent = Math.floor(this.score / 10);
        
        // æ›´æ–°æé¾™
        this.dino.velocityY += this.gravity;
        this.dino.y += this.dino.velocityY;
        
        if (this.dino.y >= 350) {
            this.dino.y = 350;
            this.dino.velocityY = 0;
            this.dino.jumping = false;
        }
        
        // ç”Ÿæˆéšœç¢ç‰©
        if (this.frame % 100 === 0) {
            this.obstacles.push({
                x: 800,
                y: 370,
                width: 30,
                height: 50
            });
        }
        
        // æ›´æ–°éšœç¢ç‰©
        for (let i = this.obstacles.length - 1; i >= 0; i--) {
            this.obstacles[i].x -= this.speed;
            
            if (this.obstacles[i].x < -50) {
                this.obstacles.splice(i, 1);
                continue;
            }
            
            // ç¢°æ’æ£€æµ‹
            if (this.checkCollision(this.dino, this.obstacles[i])) {
                this.gameOver();
            }
        }
    }
    
    render() {
        // æ¸…å±
        this.ctx.fillStyle = '#0a0118';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // åœ°é¢
        this.ctx.fillStyle = '#a855f7';
        this.ctx.fillRect(0, 400, this.canvas.width, 10);
        
        const x = this.dino.x;
        const y = this.dino.y;
        
        // æ ¹æ®è§’è‰²ç±»å‹ç»˜åˆ¶ä¸åŒå½¢çŠ¶
        if (this.character === 'cat') {
            // ç»˜åˆ¶çŒ«å’ª
            this.ctx.fillStyle = '#f97316'; // æ©™è‰²
            // èº«ä½“
            this.ctx.fillRect(x, y + 20, 40, 30);
            // å¤´
            this.ctx.fillRect(x + 25, y, 30, 25);
            // è€³æœµ
            this.ctx.beginPath();
            this.ctx.moveTo(x + 25, y);
            this.ctx.lineTo(x + 30, y - 10);
            this.ctx.lineTo(x + 35, y);
            this.ctx.fill();
            this.ctx.beginPath();
            this.ctx.moveTo(x + 45, y);
            this.ctx.lineTo(x + 50, y - 10);
            this.ctx.lineTo(x + 55, y);
            this.ctx.fill();
            // çœ¼ç›
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(x + 32, y + 8, 5, 5);
            this.ctx.fillRect(x + 43, y + 8, 5, 5);
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(x + 34, y + 10, 2, 2);
            this.ctx.fillRect(x + 45, y + 10, 2, 2);
            // é¼»å­
            this.ctx.fillStyle = '#ec4899';
            this.ctx.fillRect(x + 40, y + 16, 3, 3);
            // è…¿
            this.ctx.fillStyle = '#f97316';
            this.ctx.fillRect(x + 5, y + 50, 10, 15);
            this.ctx.fillRect(x + 25, y + 50, 10, 15);
            // å°¾å·´
            this.ctx.fillRect(x - 15, y + 20, 20, 8);
            
        } else if (this.character === 'dog') {
            // ç»˜åˆ¶å°ç‹—
            this.ctx.fillStyle = '#a855f7'; // ç´«è‰²
            // èº«ä½“
            this.ctx.fillRect(x, y + 20, 40, 30);
            // å¤´
            this.ctx.fillRect(x + 30, y + 5, 25, 20);
            // è€³æœµï¼ˆå‚ä¸‹æ¥çš„ï¼‰
            this.ctx.fillRect(x + 28, y + 3, 8, 15);
            this.ctx.fillRect(x + 52, y + 3, 8, 15);
            // çœ¼ç›
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(x + 38, y + 10, 6, 6);
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(x + 40, y + 12, 3, 3);
            // é¼»å­
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(x + 48, y + 18, 5, 4);
            // è…¿
            this.ctx.fillStyle = '#a855f7';
            this.ctx.fillRect(x + 5, y + 50, 10, 15);
            this.ctx.fillRect(x + 25, y + 50, 10, 15);
            // å°¾å·´ï¼ˆå‘ä¸Šï¼‰
            this.ctx.fillRect(x - 10, y + 15, 12, 20);
            
        } else if (this.character === 'rabbit') {
            // ç»˜åˆ¶å…”å­
            this.ctx.fillStyle = '#ffffff'; // ç™½è‰²
            // èº«ä½“
            this.ctx.fillRect(x, y + 25, 35, 25);
            // å¤´
            this.ctx.fillRect(x + 25, y + 5, 25, 25);
            // é•¿è€³æœµ
            this.ctx.fillRect(x + 28, y - 20, 8, 25);
            this.ctx.fillRect(x + 42, y - 20, 8, 25);
            // çœ¼ç›
            this.ctx.fillStyle = '#ec4899';
            this.ctx.fillRect(x + 32, y + 12, 4, 4);
            this.ctx.fillRect(x + 42, y + 12, 4, 4);
            // é¼»å­
            this.ctx.fillRect(x + 38, y + 20, 3, 3);
            // è…¿
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(x + 5, y + 50, 12, 15);
            this.ctx.fillRect(x + 22, y + 50, 12, 15);
            // çŸ­å°¾å·´
            this.ctx.beginPath();
            this.ctx.arc(x - 5, y + 35, 8, 0, Math.PI * 2);
            this.ctx.fill();
            
        } else {
            // é»˜è®¤ç»˜åˆ¶æé¾™
            this.ctx.fillStyle = '#10b981';
            // èº«ä½“
            this.ctx.fillRect(x, y + 20, 40, 30);
            // å¤´
            this.ctx.fillRect(x + 30, y, 25, 25);
            // çœ¼ç›
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(x + 45, y + 8, 6, 6);
            // è…¿
            this.ctx.fillStyle = '#10b981';
            this.ctx.fillRect(x + 5, y + 50, 10, 15);
            this.ctx.fillRect(x + 25, y + 50, 10, 15);
            // å°¾å·´
            this.ctx.fillRect(x - 10, y + 25, 15, 10);
        }
        
        // éšœç¢ç‰©ï¼ˆä»™äººæŒï¼‰
        this.ctx.fillStyle = '#ec4899';
        this.obstacles.forEach(obs => {
            // ä¸»å¹²
            this.ctx.fillRect(obs.x + 10, obs.y, 10, obs.height);
            // å·¦è‡‚
            this.ctx.fillRect(obs.x, obs.y + 15, 15, 8);
            // å³è‡‚
            this.ctx.fillRect(obs.x + 15, obs.y + 25, 15, 8);
        });
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
            this.ctx.font = '20px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            const characterName = this.character === 'cat' ? 'çŒ«å’ª' : 
                                 this.character === 'dog' ? 'å°ç‹—' : 
                                 this.character === 'rabbit' ? 'å…”å­' : 'æé¾™';
            this.ctx.fillText(`æŒ‰ç©ºæ ¼é”®è®©${characterName}è·³è·ƒ`, 400, 250);
        }
    }
    
    checkCollision(a, b) {
        return a.x < b.x + b.width &&
               a.x + a.width > b.x &&
               a.y < b.y + b.height &&
               a.y + a.height > b.y;
    }
    
    gameOver() {
        this.stop();
        setTimeout(() => {
            alert('æ¸¸æˆç»“æŸï¼å¾—åˆ†ï¼š' + Math.floor(this.score / 10));
            document.getElementById('gameOverlay').classList.remove('hidden');
        }, 100);
    }
}

// é£è¡Œæ¸¸æˆ
class BirdGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.bird = {
            x: 100,
            y: 250,
            width: 35,
            height: 35,
            velocityY: 0
        };
        
        this.pipes = [];
        this.gravity = 0.5;
        this.flapPower = -8;
        this.frame = 0;
        
        this.clickHandler = () => {
            if (this.running) this.flap();
        };
        
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.bird.y = 250;
        this.bird.velocityY = 0;
        this.pipes = [];
        this.frame = 0;
        document.getElementById('gameScore').textContent = '0';
        this.canvas.addEventListener('click', this.clickHandler);
        this.gameLoop();
    }
    
    stop() {
        this.running = false;
        this.canvas.removeEventListener('click', this.clickHandler);
    }
    
    flap() {
        this.bird.velocityY = this.flapPower;
    }
    
    gameLoop() {
        if (!this.running) return;
        
        this.update();
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    update() {
        this.frame++;
        
        // æ›´æ–°å°é¸Ÿ
        this.bird.velocityY += this.gravity;
        this.bird.y += this.bird.velocityY;
        
        if (this.bird.y < 0 || this.bird.y > 465) {
            this.gameOver();
            return;
        }
        
        // ç”Ÿæˆç®¡é“
        if (this.frame % 120 === 0) {
            const gap = 150;
            const topHeight = Math.random() * 200 + 50;
            this.pipes.push({
                x: 800,
                topHeight,
                bottomY: topHeight + gap,
                width: 60,
                passed: false
            });
        }
        
        // æ›´æ–°ç®¡é“
        for (let i = this.pipes.length - 1; i >= 0; i--) {
            this.pipes[i].x -= 3;
            
            if (this.pipes[i].x < -60) {
                this.pipes.splice(i, 1);
                continue;
            }
            
            // å¾—åˆ†
            if (!this.pipes[i].passed && this.pipes[i].x + this.pipes[i].width < this.bird.x) {
                this.pipes[i].passed = true;
                this.score++;
                document.getElementById('gameScore').textContent = this.score;
            }
            
            // ç¢°æ’
            if (this.bird.x < this.pipes[i].x + this.pipes[i].width && 
                this.bird.x + this.bird.width > this.pipes[i].x) {
                if (this.bird.y < this.pipes[i].topHeight || 
                    this.bird.y + this.bird.height > this.pipes[i].bottomY) {
                    this.gameOver();
                }
            }
        }
    }
    
    render() {
        // æ¸…å±
        this.ctx.fillStyle = '#0f0729';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶å°é¸Ÿï¼ˆæ”¹ä¸ºé¸Ÿçš„å½¢çŠ¶ï¼‰
        this.ctx.fillStyle = '#fbbf24';
        const x = this.bird.x;
        const y = this.bird.y;
        
        // èº«ä½“ï¼ˆåœ†å½¢ï¼‰
        this.ctx.beginPath();
        this.ctx.arc(x + 17, y + 17, 17, 0, Math.PI * 2);
        this.ctx.fill();
        
        // ç¿…è†€
        this.ctx.fillStyle = '#f59e0b';
        this.ctx.beginPath();
        this.ctx.ellipse(x + 5, y + 20, 12, 8, -0.3, 0, Math.PI * 2);
        this.ctx.fill();
        
        // çœ¼ç›
        this.ctx.fillStyle = '#ffffff';
        this.ctx.beginPath();
        this.ctx.arc(x + 24, y + 12, 5, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.fillStyle = '#000000';
        this.ctx.beginPath();
        this.ctx.arc(x + 26, y + 12, 2, 0, Math.PI * 2);
        this.ctx.fill();
        
        // å˜´å·´
        this.ctx.fillStyle = '#f97316';
        this.ctx.beginPath();
        this.ctx.moveTo(x + 30, y + 15);
        this.ctx.lineTo(x + 38, y + 17);
        this.ctx.lineTo(x + 30, y + 19);
        this.ctx.fill();
        
        // ç®¡é“
        this.ctx.fillStyle = '#06b6d4';
        this.pipes.forEach(pipe => {
            this.ctx.fillRect(pipe.x, 0, pipe.width, pipe.topHeight);
            this.ctx.fillRect(pipe.x, pipe.bottomY, pipe.width, 500 - pipe.bottomY);
        });
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
            this.ctx.font = '20px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('ç‚¹å‡»ç”»å¸ƒè®©å°é¸Ÿé£èµ·æ¥', 400, 250);
        }
    }
    
    gameOver() {
        this.stop();
        setTimeout(() => {
            alert('æ¸¸æˆç»“æŸï¼å¾—åˆ†ï¼š' + this.score);
            document.getElementById('gameOverlay').classList.remove('hidden');
        }, 100);
    }
}

// æ¶ˆé™¤æ¸¸æˆ
class MatchGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.rows = 8;
        this.cols = 10;
        this.blockSize = 50;
        this.colors = ['#a855f7', '#ec4899', '#06b6d4', '#10b981', '#fbbf24'];
        this.grid = [];
        this.selected = null;
        
        this.clickHandler = (e) => this.handleClick(e);
        
        this.initGrid();
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.selected = null;
        this.initGrid();
        this.canvas.addEventListener('click', this.clickHandler);
        this.render();
    }
    
    stop() {
        this.running = false;
        this.canvas.removeEventListener('click', this.clickHandler);
    }
    
    initGrid() {
        this.grid = [];
        for (let row = 0; row < this.rows; row++) {
            this.grid[row] = [];
            for (let col = 0; col < this.cols; col++) {
                this.grid[row][col] = {
                    color: this.colors[Math.floor(Math.random() * this.colors.length)],
                    x: col * this.blockSize + 150,
                    y: row * this.blockSize + 10
                };
            }
        }
    }
    
    handleClick(e) {
        if (!this.running) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const col = Math.floor((x - 150) / this.blockSize);
        const row = Math.floor((y - 10) / this.blockSize);
        
        if (row >= 0 && row < this.rows && col >= 0 && col < this.cols) {
            if (!this.selected) {
                this.selected = { row, col };
            } else {
                this.trySwap(this.selected.row, this.selected.col, row, col);
                this.selected = null;
            }
            this.render();
        }
    }
    
    trySwap(r1, c1, r2, c2) {
        const adjacent = (Math.abs(r1 - r2) === 1 && c1 === c2) ||
                        (Math.abs(c1 - c2) === 1 && r1 === r2);
        
        if (adjacent) {
            const temp = this.grid[r1][c1].color;
            this.grid[r1][c1].color = this.grid[r2][c2].color;
            this.grid[r2][c2].color = temp;
            
            if (this.checkMatches()) {
                this.score += 10;
                document.getElementById('gameScore').textContent = this.score;
            } else {
                // æ¢å›
                const temp = this.grid[r1][c1].color;
                this.grid[r1][c1].color = this.grid[r2][c2].color;
                this.grid[r2][c2].color = temp;
            }
            this.render();
        }
    }
    
    checkMatches() {
        let hasMatch = false;
        const toRemove = new Set();
        
        // æ¨ªå‘æ£€æŸ¥
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols - 2; c++) {
                const color = this.grid[r][c].color;
                if (color === this.grid[r][c + 1].color && 
                    color === this.grid[r][c + 2].color) {
                    toRemove.add(`${r},${c}`);
                    toRemove.add(`${r},${c + 1}`);
                    toRemove.add(`${r},${c + 2}`);
                    hasMatch = true;
                }
            }
        }
        
        // çºµå‘æ£€æŸ¥
        for (let c = 0; c < this.cols; c++) {
            for (let r = 0; r < this.rows - 2; r++) {
                const color = this.grid[r][c].color;
                if (color === this.grid[r + 1][c].color && 
                    color === this.grid[r + 2][c].color) {
                    toRemove.add(`${r},${c}`);
                    toRemove.add(`${r + 1},${c}`);
                    toRemove.add(`${r + 2},${c}`);
                    hasMatch = true;
                }
            }
        }
        
        // ç§»é™¤åŒ¹é…
        toRemove.forEach(key => {
            const [r, c] = key.split(',').map(Number);
            this.grid[r][c].color = this.colors[Math.floor(Math.random() * this.colors.length)];
        });
        
        return hasMatch;
    }
    
    render() {
        // æ¸…å±
        this.ctx.fillStyle = '#0a0118';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶æ–¹å—
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const block = this.grid[r][c];
                this.ctx.fillStyle = block.color;
                this.ctx.fillRect(block.x + 2, block.y + 2, this.blockSize - 4, this.blockSize - 4);
                
                // é€‰ä¸­é«˜äº®
                if (this.selected && this.selected.row === r && this.selected.col === c) {
                    this.ctx.strokeStyle = '#ffffff';
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeRect(block.x + 2, block.y + 2, this.blockSize - 4, this.blockSize - 4);
                }
            }
        }
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
            this.ctx.font = '18px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('ç‚¹å‡»ä¸¤ä¸ªç›¸é‚»æ–¹å—äº¤æ¢ä½ç½®', 400, 460);
        }
    }
}

// å¤ªç©ºå†’é™©æ¸¸æˆ
class SpaceGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.ship = {
            x: 100,
            y: 250,
            width: 50,
            height: 30,
            velocityY: 0
        };
        
        this.meteors = [];
        this.stars = [];
        this.gravity = 0.4;
        this.thrustPower = -6;
        this.frame = 0;
        
        // ç”Ÿæˆæ˜Ÿæ˜ŸèƒŒæ™¯
        for (let i = 0; i < 50; i++) {
            this.stars.push({
                x: Math.random() * 800,
                y: Math.random() * 500,
                size: Math.random() * 2
            });
        }
        
        this.keyHandler = (e) => {
            if (e.code === 'Space' && this.running) {
                this.thrust();
                e.preventDefault();
            }
        };
        
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.ship.y = 250;
        this.ship.velocityY = 0;
        this.meteors = [];
        this.frame = 0;
        document.getElementById('gameScore').textContent = '0';
        document.addEventListener('keydown', this.keyHandler);
        this.gameLoop();
    }
    
    stop() {
        this.running = false;
        document.removeEventListener('keydown', this.keyHandler);
    }
    
    thrust() {
        this.ship.velocityY = this.thrustPower;
    }
    
    gameLoop() {
        if (!this.running) return;
        
        this.update();
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    update() {
        this.frame++;
        
        // æ›´æ–°é£èˆ¹
        this.ship.velocityY += this.gravity;
        this.ship.y += this.ship.velocityY;
        
        if (this.ship.y < 0 || this.ship.y > 470) {
            this.gameOver();
            return;
        }
        
        // ç”Ÿæˆé™¨çŸ³
        if (this.frame % 80 === 0) {
            this.meteors.push({
                x: 800,
                y: Math.random() * 400 + 50,
                size: 30 + Math.random() * 20,
                speed: 3 + Math.random() * 2,
                passed: false
            });
        }
        
        // æ›´æ–°é™¨çŸ³
        for (let i = this.meteors.length - 1; i >= 0; i--) {
            this.meteors[i].x -= this.meteors[i].speed;
            
            if (this.meteors[i].x < -60) {
                this.meteors.splice(i, 1);
                continue;
            }
            
            // å¾—åˆ†
            if (!this.meteors[i].passed && this.meteors[i].x + this.meteors[i].size < this.ship.x) {
                this.meteors[i].passed = true;
                this.score++;
                document.getElementById('gameScore').textContent = this.score;
            }
            
            // ç¢°æ’æ£€æµ‹
            const dx = this.ship.x + 25 - (this.meteors[i].x + this.meteors[i].size / 2);
            const dy = this.ship.y + 15 - (this.meteors[i].y + this.meteors[i].size / 2);
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < this.meteors[i].size / 2 + 20) {
                this.gameOver();
            }
        }
        
        // æ›´æ–°æ˜Ÿæ˜Ÿ
        this.stars.forEach(star => {
            star.x -= 0.5;
            if (star.x < 0) star.x = 800;
        });
    }
    
    render() {
        // å¤ªç©ºèƒŒæ™¯
        this.ctx.fillStyle = '#050014';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // æ˜Ÿæ˜Ÿ
        this.ctx.fillStyle = '#ffffff';
        this.stars.forEach(star => {
            this.ctx.fillRect(star.x, star.y, star.size, star.size);
        });
        
        // å¤ªç©ºé£èˆ¹
        this.ctx.fillStyle = '#10b981';
        const x = this.ship.x;
        const y = this.ship.y;
        
        // èˆ¹ä½“
        this.ctx.beginPath();
        this.ctx.moveTo(x, y + 15);
        this.ctx.lineTo(x + 40, y);
        this.ctx.lineTo(x + 50, y + 15);
        this.ctx.lineTo(x + 40, y + 30);
        this.ctx.closePath();
        this.ctx.fill();
        
        // çª—æˆ·
        this.ctx.fillStyle = '#06b6d4';
        this.ctx.beginPath();
        this.ctx.arc(x + 25, y + 15, 6, 0, Math.PI * 2);
        this.ctx.fill();
        
        // å¼•æ“ç«ç„°
        if (this.ship.velocityY < 0) {
            this.ctx.fillStyle = '#f97316';
            this.ctx.beginPath();
            this.ctx.moveTo(x, y + 10);
            this.ctx.lineTo(x - 15, y + 15);
            this.ctx.lineTo(x, y + 20);
            this.ctx.fill();
        }
        
        // é™¨çŸ³
        this.meteors.forEach(meteor => {
            this.ctx.fillStyle = '#78716c';
            this.ctx.beginPath();
            this.ctx.arc(meteor.x + meteor.size / 2, meteor.y + meteor.size / 2, meteor.size / 2, 0, Math.PI * 2);
            this.ctx.fill();
            
            // é™¨çŸ³çº¹ç†
            this.ctx.fillStyle = '#57534e';
            this.ctx.beginPath();
            this.ctx.arc(meteor.x + meteor.size / 3, meteor.y + meteor.size / 3, meteor.size / 6, 0, Math.PI * 2);
            this.ctx.fill();
        });
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
            this.ctx.font = '20px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('æŒ‰ç©ºæ ¼é”®æ§åˆ¶é£èˆ¹ä¸Šå‡', 400, 250);
        }
    }
    
    gameOver() {
        this.stop();
        setTimeout(() => {
            alert('æ¸¸æˆç»“æŸï¼å¾—åˆ†ï¼š' + this.score);
            document.getElementById('gameOverlay').classList.remove('hidden');
        }, 100);
    }
}

// è¿è¿çœ‹æ¸¸æˆ
class ConnectGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.rows = 6;
        this.cols = 8;
        this.blockSize = 60;
        this.icons = ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¹', 'ğŸŒ·', 'ğŸŒ¼', 'ğŸ€', 'ğŸŒ¿', 'ğŸ', 'ğŸ‚', 'ğŸŒ¾', 'ğŸŒµ'];
        this.grid = [];
        this.selected = null;
        
        this.clickHandler = (e) => this.handleClick(e);
        
        this.initGrid();
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.selected = null;
        this.initGrid();
        document.getElementById('gameScore').textContent = '0';
        this.canvas.addEventListener('click', this.clickHandler);
        this.render();
    }
    
    stop() {
        this.running = false;
        this.canvas.removeEventListener('click', this.clickHandler);
    }
    
    initGrid() {
        this.grid = [];
        const pairs = [];
        const iconCount = (this.rows * this.cols) / 2;
        
        // åˆ›å»ºé…å¯¹
        for (let i = 0; i < iconCount; i++) {
            const icon = this.icons[i % this.icons.length];
            pairs.push(icon, icon);
        }
        
        // æ‰“ä¹±
        pairs.sort(() => Math.random() - 0.5);
        
        // å¡«å……ç½‘æ ¼
        let index = 0;
        for (let row = 0; row < this.rows; row++) {
            this.grid[row] = [];
            for (let col = 0; col < this.cols; col++) {
                this.grid[row][col] = {
                    icon: pairs[index++],
                    x: col * this.blockSize + 100,
                    y: row * this.blockSize + 50,
                    matched: false
                };
            }
        }
    }
    
    handleClick(e) {
        if (!this.running) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const col = Math.floor((x - 100) / this.blockSize);
        const row = Math.floor((y - 50) / this.blockSize);
        
        if (row >= 0 && row < this.rows && col >= 0 && col < this.cols) {
            const block = this.grid[row][col];
            if (block.matched) return;
            
            if (!this.selected) {
                this.selected = { row, col };
            } else {
                if (this.selected.row === row && this.selected.col === col) {
                    this.selected = null;
                } else {
                    this.tryMatch(this.selected.row, this.selected.col, row, col);
                    this.selected = null;
                }
            }
            this.render();
        }
    }
    
    tryMatch(r1, c1, r2, c2) {
        const block1 = this.grid[r1][c1];
        const block2 = this.grid[r2][c2];
        
        if (block1.icon === block2.icon) {
            block1.matched = true;
            block2.matched = true;
            this.score += 10;
            document.getElementById('gameScore').textContent = this.score;
            
            // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨æ¶ˆé™¤
            let allMatched = true;
            for (let r = 0; r < this.rows; r++) {
                for (let c = 0; c < this.cols; c++) {
                    if (!this.grid[r][c].matched) {
                        allMatched = false;
                        break;
                    }
                }
                if (!allMatched) break;
            }
            
            if (allMatched) {
                setTimeout(() => {
                    alert('æ­å–œï¼å…¨éƒ¨æ¶ˆé™¤ï¼å¾—åˆ†ï¼š' + this.score);
                    this.initGrid();
                    this.render();
                }, 500);
            }
        }
    }
    
    render() {
        // æ¸…å±
        this.ctx.fillStyle = '#1a0b2e';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶æ–¹å—
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const block = this.grid[r][c];
                
                if (block.matched) continue;
                
                // èƒŒæ™¯
                this.ctx.fillStyle = '#8b5cf6';
                this.ctx.fillRect(block.x + 3, block.y + 3, this.blockSize - 6, this.blockSize - 6);
                
                // é€‰ä¸­é«˜äº®
                if (this.selected && this.selected.row === r && this.selected.col === c) {
                    this.ctx.strokeStyle = '#fbbf24';
                    this.ctx.lineWidth = 4;
                    this.ctx.strokeRect(block.x + 3, block.y + 3, this.blockSize - 6, this.blockSize - 6);
                }
                
                // å›¾æ ‡
                this.ctx.font = '32px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(block.icon, block.x + this.blockSize / 2, block.y + this.blockSize / 2);
            }
        }
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
            this.ctx.font = '18px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('ç‚¹å‡»ä¸¤ä¸ªç›¸åŒå›¾æ¡ˆè¿›è¡Œè¿çº¿æ¶ˆé™¤', 400, 450);
        }
    }
}

// è·‘é…·æ¸¸æˆ
class ParkourGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.player = {
            x: 100,
            y: 300,
            width: 30,
            height: 40,
            velocityY: 0,
            jumping: false
        };
        
        this.platforms = [];
        this.coins = [];
        this.obstacles = [];
        this.gravity = 0.8;
        this.jumpPower = -14;
        this.speed = 3;
        this.frame = 0;
        
        this.keyHandler = (e) => {
            if (e.code === 'Space' && this.running) {
                this.jump();
                e.preventDefault();
            }
        };
        
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.player.y = 300;
        this.player.velocityY = 0;
        this.player.jumping = false;
        this.platforms = [{ x: 0, y: 350, width: 800, height: 20 }];
        this.coins = [];
        this.obstacles = [];
        this.frame = 0;
        document.getElementById('gameScore').textContent = '0';
        document.addEventListener('keydown', this.keyHandler);
        this.gameLoop();
    }
    
    stop() {
        this.running = false;
        document.removeEventListener('keydown', this.keyHandler);
    }
    
    jump() {
        if (!this.player.jumping) {
            this.player.velocityY = this.jumpPower;
            this.player.jumping = true;
        }
    }
    
    gameLoop() {
        if (!this.running) return;
        
        this.update();
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    update() {
        this.frame++;
        
        // æ›´æ–°ç©å®¶
        this.player.velocityY += this.gravity;
        this.player.y += this.player.velocityY;
        
        // æ£€æŸ¥å¹³å°ç¢°æ’
        let onPlatform = false;
        for (let platform of this.platforms) {
            if (this.player.x + this.player.width > platform.x &&
                this.player.x < platform.x + platform.width &&
                this.player.y + this.player.height >= platform.y &&
                this.player.y + this.player.height <= platform.y + 20 &&
                this.player.velocityY >= 0) {
                this.player.y = platform.y - this.player.height;
                this.player.velocityY = 0;
                this.player.jumping = false;
                onPlatform = true;
            }
        }
        
        // æ‰è½æ£€æµ‹
        if (this.player.y > 500) {
            this.gameOver();
            return;
        }
        
        // ç”Ÿæˆé‡‘å¸
        if (this.frame % 60 === 0) {
            this.coins.push({
                x: 800,
                y: 250 + Math.random() * 50,
                size: 20
            });
        }
        
        // æ›´æ–°é‡‘å¸
        for (let i = this.coins.length - 1; i >= 0; i--) {
            this.coins[i].x -= this.speed;
            
            if (this.coins[i].x < -20) {
                this.coins.splice(i, 1);
                continue;
            }
            
            // æ”¶é›†é‡‘å¸
            const dx = this.player.x + 15 - (this.coins[i].x + 10);
            const dy = this.player.y + 20 - (this.coins[i].y + 10);
            if (Math.sqrt(dx * dx + dy * dy) < 25) {
                this.coins.splice(i, 1);
                this.score += 10;
                document.getElementById('gameScore').textContent = this.score;
            }
        }
        
        // ç”Ÿæˆéšœç¢
        if (this.frame % 120 === 0) {
            this.obstacles.push({
                x: 800,
                y: 320,
                width: 30,
                height: 30
            });
        }
        
        // æ›´æ–°éšœç¢
        for (let i = this.obstacles.length - 1; i >= 0; i--) {
            this.obstacles[i].x -= this.speed;
            
            if (this.obstacles[i].x < -40) {
                this.obstacles.splice(i, 1);
                continue;
            }
            
            // ç¢°æ’æ£€æµ‹
            if (this.player.x < this.obstacles[i].x + this.obstacles[i].width &&
                this.player.x + this.player.width > this.obstacles[i].x &&
                this.player.y < this.obstacles[i].y + this.obstacles[i].height &&
                this.player.y + this.player.height > this.obstacles[i].y) {
                this.gameOver();
            }
        }
    }
    
    render() {
        // å¤©ç©º
        const gradient = this.ctx.createLinearGradient(0, 0, 0, 500);
        gradient.addColorStop(0, '#87CEEB');
        gradient.addColorStop(1, '#E0F6FF');
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // å¹³å°
        this.ctx.fillStyle = '#8B4513';
        this.platforms.forEach(platform => {
            this.ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        });
        
        // ç©å®¶
        this.ctx.fillStyle = '#FF6347';
        this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height);
        
        // çœ¼ç›
        this.ctx.fillStyle = '#ffffff';
        this.ctx.fillRect(this.player.x + 18, this.player.y + 8, 8, 8);
        this.ctx.fillStyle = '#000000';
        this.ctx.fillRect(this.player.x + 21, this.player.y + 11, 3, 3);
        
        // é‡‘å¸
        this.ctx.fillStyle = '#FFD700';
        this.coins.forEach(coin => {
            this.ctx.beginPath();
            this.ctx.arc(coin.x + 10, coin.y + 10, coin.size / 2, 0, Math.PI * 2);
            this.ctx.fill();
            this.ctx.strokeStyle = '#FFA500';
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
        });
        
        // éšœç¢ç‰©
        this.ctx.fillStyle = '#8B008B';
        this.obstacles.forEach(obs => {
            this.ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
        });
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(0,0,0,0.7)';
            this.ctx.font = '20px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('æŒ‰ç©ºæ ¼é”®è·³è·ƒï¼Œæ”¶é›†é‡‘å¸ï¼Œèº²é¿éšœç¢', 400, 250);
        }
    }
    
    gameOver() {
        this.stop();
        setTimeout(() => {
            alert('æ¸¸æˆç»“æŸï¼å¾—åˆ†ï¼š' + this.score);
            document.getElementById('gameOverlay').classList.remove('hidden');
        }, 100);
    }
}

// ==================== äº’åŠ¨åŠŸèƒ½ ====================
function toggleLike() {
    if (!currentGame) return;
    
    const gameId = currentGame.id;
    const index = appData.userLikes.indexOf(gameId);
    
    if (index > -1) {
        appData.userLikes.splice(index, 1);
        currentGame.likes--;
        document.getElementById('likeIcon').textContent = 'ğŸ¤';
        document.getElementById('likeText').textContent = 'ç‚¹èµ';
        document.getElementById('likeBtn').classList.remove('liked');
    } else {
        appData.userLikes.push(gameId);
        currentGame.likes++;
        document.getElementById('likeIcon').textContent = 'â¤ï¸';
        document.getElementById('likeText').textContent = 'å·²èµ';
        document.getElementById('likeBtn').classList.add('liked');
    }
    
    document.getElementById('likeCount').textContent = currentGame.likes;
    Storage.save(appData);
    
    renderGameGallery();
    renderRanking(currentRanking);
}

function shareGame() {
    if (!currentGame) return;
    alert(`ğŸ”— åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼\n\næ¸¸æˆï¼š${currentGame.title}\nä½œè€…ï¼š${currentGame.author}\n\nå¿«æ¥ä½“éªŒè¿™ä¸ªç”±AIåˆ›ä½œçš„æ¸¸æˆå§ï¼`);
}

function focusCommentInput() {
    switchTab('comments');
    document.getElementById('commentInput').focus();
}

// ==================== è¯„è®ºåŠŸèƒ½ ====================
function submitComment(commentId = null) {
    if (!currentGame) return;
    
    const input = document.getElementById(commentId ? `replyInput_${commentId}` : 'commentInput');
    const text = input.value.trim();
    
    if (!text) {
        alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
        return;
    }
    
    const timeStr = new Date().toLocaleString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    if (commentId) {
        // å›å¤è¯„è®º
        const comment = currentGame.comments.find(c => c.id === commentId);
        if (comment) {
            if (!comment.replies) comment.replies = [];
            comment.replies.push({
                author: 'æˆ‘',
                content: text,
                time: timeStr
            });
        }
    } else {
        // æ–°è¯„è®º
        const comment = {
            id: Date.now(),
            author: 'æˆ‘',
            content: text,
            time: timeStr,
            replies: []
        };
        currentGame.comments.push(comment);
    }
    
    Storage.save(appData);
    
    input.value = '';
    
    // æ›´æ–°è¯„è®ºæ•°
    const totalComments = currentGame.comments.length + currentGame.comments.reduce((sum, c) => sum + (c.replies ? c.replies.length : 0), 0);
    document.getElementById('commentCountBtn').textContent = totalComments;
    
    renderComments();
    renderGameGallery(); // æ›´æ–°ç”»å»Šä¸­çš„è¯„è®ºæ•°
}

function renderComments() {
    if (!currentGame) return;
    
    const list = document.getElementById('commentsList');
    
    if (currentGame.comments.length === 0) {
        list.innerHTML = '<p class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>';
        return;
    }
    
    list.innerHTML = [...currentGame.comments].reverse().map(comment => `
        <div class="comment-item">
            <div class="comment-header">
                <span class="comment-author">${comment.author}</span>
                <span class="comment-time">${comment.time}</span>
            </div>
            <div class="comment-content">${comment.content}</div>
            ${comment.replies && comment.replies.length > 0 ? `
                <div class="comment-replies">
                    ${comment.replies.map(reply => `
                        <div class="reply-item">
                            <span class="reply-author">${reply.author}</span>
                            <span class="reply-content">${reply.content}</span>
                            <span class="reply-time">${reply.time}</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <div class="comment-actions">
                <button class="btn-reply" onclick="toggleReplyBox(${comment.id})">ğŸ’¬ å›å¤</button>
            </div>
            <div class="reply-box" id="replyBox_${comment.id}" style="display: none;">
                <textarea 
                    id="replyInput_${comment.id}" 
                    class="reply-input" 
                    rows="2" 
                    placeholder="å›å¤ @${comment.author}..."
                ></textarea>
                <div class="reply-actions">
                    <button class="btn-cancel-reply" onclick="toggleReplyBox(${comment.id})">å–æ¶ˆ</button>
                    <button class="btn-submit-reply" onclick="submitComment(${comment.id})">å‘é€</button>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleReplyBox(commentId) {
    const replyBox = document.getElementById(`replyBox_${commentId}`);
    if (replyBox.style.display === 'none') {
        // å…³é—­å…¶ä»–å›å¤æ¡†
        document.querySelectorAll('.reply-box').forEach(box => box.style.display = 'none');
        replyBox.style.display = 'block';
        document.getElementById(`replyInput_${commentId}`).focus();
    } else {
        replyBox.style.display = 'none';
    }
}
    

// åˆ é™¤æ¸¸æˆ
function deleteGame(gameId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¸¸æˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
    }
    
    const index = appData.games.findIndex(g => g.id === gameId);
    if (index > -1) {
        appData.games.splice(index, 1);
        Storage.save(appData);
        closeGameModal();
        renderGameGallery();
        updateMyGamesCount();
        renderRanking(currentRanking);
        alert('æ¸¸æˆå·²åˆ é™¤ï¼');
    }
}

// ==================== RemixåŠŸèƒ½ ====================
function remixGame() {
    if (!currentGame) return;
    
    closeGameModal();
    openCreator();
    
    const remixPrompt = `${currentGame.prompt}\n\nï¼ˆåŸºäº @${currentGame.author} çš„ã€Š${currentGame.title}ã€‹è¿›è¡ŒäºŒåˆ›ï¼‰`;
    document.getElementById('gamePrompt').value = remixPrompt;
}

// ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
function switchTab(tabName) {
    // æ›´æ–°æŒ‰é’®
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // æ›´æ–°é¢æ¿
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
}

// é£æœºå¤§æˆ˜æ¸¸æˆ
class ShootGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.player = {
            x: 360,
            y: 400,
            width: 40,
            height: 50,
            speed: 6
        };
        
        this.bullets = [];
        this.enemies = [];
        this.frame = 0;
        
        this.keys = {
            left: false,
            right: false,
            up: false,
            down: false,
            space: false
        };
        
        this.keyDownHandler = (e) => {
            if (!this.running) return;
            if (e.key === 'ArrowLeft') this.keys.left = true;
            if (e.key === 'ArrowRight') this.keys.right = true;
            if (e.key === 'ArrowUp') this.keys.up = true;
            if (e.key === 'ArrowDown') this.keys.down = true;
            if (e.code === 'Space') {
                this.keys.space = true;
                e.preventDefault();
            }
        };
        
        this.keyUpHandler = (e) => {
            if (e.key === 'ArrowLeft') this.keys.left = false;
            if (e.key === 'ArrowRight') this.keys.right = false;
            if (e.key === 'ArrowUp') this.keys.up = false;
            if (e.key === 'ArrowDown') this.keys.down = false;
            if (e.code === 'Space') this.keys.space = false;
        };
        
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.bullets = [];
        this.enemies = [];
        this.frame = 0;
        this.player.x = 360;
        this.player.y = 400;
        document.getElementById('gameScore').textContent = '0';
        document.addEventListener('keydown', this.keyDownHandler);
        document.addEventListener('keyup', this.keyUpHandler);
        this.gameLoop();
    }
    
    stop() {
        this.running = false;
        document.removeEventListener('keydown', this.keyDownHandler);
        document.removeEventListener('keyup', this.keyUpHandler);
    }
    
    shoot() {
        this.bullets.push({
            x: this.player.x + this.player.width / 2 - 2,
            y: this.player.y - 10,
            width: 4,
            height: 12,
            speed: 8
        });
    }
    
    gameLoop() {
        if (!this.running) return;
        
        this.update();
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    update() {
        this.frame++;
        
        // ç©å®¶ç§»åŠ¨
        if (this.keys.left && this.player.x > 0) {
            this.player.x -= this.player.speed;
        }
        if (this.keys.right && this.player.x < 800 - this.player.width) {
            this.player.x += this.player.speed;
        }
        if (this.keys.up && this.player.y > 0) {
            this.player.y -= this.player.speed;
        }
        if (this.keys.down && this.player.y < 500 - this.player.height) {
            this.player.y += this.player.speed;
        }
        
        // è‡ªåŠ¨å°„å‡»
        if (this.frame % 15 === 0) {
            this.shoot();
        }
        
        // æ›´æ–°å­å¼¹
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            this.bullets[i].y -= this.bullets[i].speed;
            
            if (this.bullets[i].y < -20) {
                this.bullets.splice(i, 1);
            }
        }
        
        // ç”Ÿæˆæ•Œæœº
        if (this.frame % 60 === 0) {
            this.enemies.push({
                x: Math.random() * (800 - 40),
                y: -50,
                width: 40,
                height: 40,
                speed: 2 + Math.random() * 2
            });
        }
        
        // æ›´æ–°æ•Œæœº
        for (let i = this.enemies.length - 1; i >= 0; i--) {
            this.enemies[i].y += this.enemies[i].speed;
            
            // ç§»é™¤è¶…å‡ºå±å¹•çš„æ•Œæœº
            if (this.enemies[i].y > 500) {
                this.enemies.splice(i, 1);
                continue;
            }
            
            // å­å¼¹å‡»ä¸­æ•Œæœº
            for (let j = this.bullets.length - 1; j >= 0; j--) {
                if (this.checkCollision(this.bullets[j], this.enemies[i])) {
                    this.bullets.splice(j, 1);
                    this.enemies.splice(i, 1);
                    this.score += 10;
                    document.getElementById('gameScore').textContent = this.score;
                    break;
                }
            }
            
            // æ•Œæœºæ’åˆ°ç©å®¶
            if (this.enemies[i] && this.checkCollision(this.player, this.enemies[i])) {
                this.gameOver();
                return;
            }
        }
    }
    
    render() {
        // å¤©ç©ºèƒŒæ™¯
        const gradient = this.ctx.createLinearGradient(0, 0, 0, 500);
        gradient.addColorStop(0, '#1a0b2e');
        gradient.addColorStop(1, '#3a1f5d');
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // æ˜Ÿæ˜ŸèƒŒæ™¯
        this.ctx.fillStyle = '#ffffff';
        for (let i = 0; i < 30; i++) {
            const x = (i * 137 + this.frame) % 800;
            const y = (i * 211) % 500;
            this.ctx.fillRect(x, y, 2, 2);
        }
        
        // ç»˜åˆ¶ç©å®¶é£æœº
        this.ctx.fillStyle = '#10b981';
        const px = this.player.x;
        const py = this.player.y;
        
        // æœºèº«
        this.ctx.beginPath();
        this.ctx.moveTo(px + 20, py);
        this.ctx.lineTo(px + 35, py + 40);
        this.ctx.lineTo(px + 5, py + 40);
        this.ctx.closePath();
        this.ctx.fill();
        
        // æœºç¿¼
        this.ctx.fillStyle = '#06b6d4';
        this.ctx.fillRect(px, py + 25, 40, 8);
        
        // é©¾é©¶èˆ±
        this.ctx.fillStyle = '#fbbf24';
        this.ctx.beginPath();
        this.ctx.arc(px + 20, py + 15, 5, 0, Math.PI * 2);
        this.ctx.fill();
        
        // ç»˜åˆ¶å­å¼¹
        this.ctx.fillStyle = '#fbbf24';
        this.bullets.forEach(bullet => {
            this.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        });
        
        // ç»˜åˆ¶æ•Œæœº
        this.ctx.fillStyle = '#ec4899';
        this.enemies.forEach(enemy => {
            const ex = enemy.x;
            const ey = enemy.y;
            
            // æ•Œæœºæœºèº«
            this.ctx.beginPath();
            this.ctx.moveTo(ex + 20, ey + 40);
            this.ctx.lineTo(ex + 5, ey);
            this.ctx.lineTo(ex + 35, ey);
            this.ctx.closePath();
            this.ctx.fill();
            
            // æ•Œæœºæœºç¿¼
            this.ctx.fillStyle = '#f97316';
            this.ctx.fillRect(ex, ey + 15, 40, 8);
            this.ctx.fillStyle = '#ec4899';
        });
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
            this.ctx.font = '20px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('æ–¹å‘é”®ç§»åŠ¨ï¼Œè‡ªåŠ¨å°„å‡»', 400, 250);
        }
    }
    
    checkCollision(a, b) {
        return a.x < b.x + b.width &&
               a.x + a.width > b.x &&
               a.y < b.y + b.height &&
               a.y + a.height > b.y;
    }
    
    gameOver() {
        this.stop();
        setTimeout(() => {
            alert('æ¸¸æˆç»“æŸï¼å¾—åˆ†ï¼š' + this.score);
            document.getElementById('gameOverlay').classList.remove('hidden');
        }, 100);
    }
}

// å¦å…‹å®ˆå®¶æ¸¸æˆ
class TankGame {
    constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.running = false;
        this.score = 0;
        
        this.tank = {
            x: 360,
            y: 420,
            width: 40,
            height: 40,
            speed: 5,
            angle: 0
        };
        
        this.base = {
            x: 360,
            y: 460,
            width: 80,
            height: 40,
            health: 100
        };
        
        this.bullets = [];
        this.enemies = [];
        this.frame = 0;
        
        this.keys = {
            left: false,
            right: false,
            up: false,
            down: false
        };
        
        this.keyDownHandler = (e) => {
            if (!this.running) return;
            if (e.key === 'ArrowLeft') this.keys.left = true;
            if (e.key === 'ArrowRight') this.keys.right = true;
            if (e.key === 'ArrowUp') this.keys.up = true;
            if (e.key === 'ArrowDown') this.keys.down = true;
            if (e.code === 'Space') {
                this.shoot();
                e.preventDefault();
            }
        };
        
        this.keyUpHandler = (e) => {
            if (e.key === 'ArrowLeft') this.keys.left = false;
            if (e.key === 'ArrowRight') this.keys.right = false;
            if (e.key === 'ArrowUp') this.keys.up = false;
            if (e.key === 'ArrowDown') this.keys.down = false;
        };
        
        this.render();
    }
    
    start() {
        this.running = true;
        this.score = 0;
        this.bullets = [];
        this.enemies = [];
        this.frame = 0;
        this.tank.x = 360;
        this.tank.y = 420;
        this.tank.angle = 0;
        this.base.health = 100;
        document.getElementById('gameScore').textContent = '0';
        document.addEventListener('keydown', this.keyDownHandler);
        document.addEventListener('keyup', this.keyUpHandler);
        this.gameLoop();
    }
    
    stop() {
        this.running = false;
        document.removeEventListener('keydown', this.keyDownHandler);
        document.removeEventListener('keyup', this.keyUpHandler);
    }
    
    shoot() {
        const bulletSpeed = 8;
        const angle = this.tank.angle;
        this.bullets.push({
            x: this.tank.x + 20,
            y: this.tank.y + 20,
            vx: Math.cos(angle) * bulletSpeed,
            vy: Math.sin(angle) * bulletSpeed,
            width: 6,
            height: 6
        });
    }
    
    gameLoop() {
        if (!this.running) return;
        
        this.update();
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    update() {
        this.frame++;
        
        // å¦å…‹ç§»åŠ¨
        if (this.keys.left && this.tank.x > 0) {
            this.tank.x -= this.tank.speed;
            this.tank.angle = Math.PI;
        }
        if (this.keys.right && this.tank.x < 800 - this.tank.width) {
            this.tank.x += this.tank.speed;
            this.tank.angle = 0;
        }
        if (this.keys.up && this.tank.y > 0) {
            this.tank.y -= this.tank.speed;
            this.tank.angle = -Math.PI / 2;
        }
        if (this.keys.down && this.tank.y < 420) {
            this.tank.y += this.tank.speed;
            this.tank.angle = Math.PI / 2;
        }
        
        // æ›´æ–°å­å¼¹
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            this.bullets[i].x += this.bullets[i].vx;
            this.bullets[i].y += this.bullets[i].vy;
            
            if (this.bullets[i].x < 0 || this.bullets[i].x > 800 || 
                this.bullets[i].y < 0 || this.bullets[i].y > 500) {
                this.bullets.splice(i, 1);
            }
        }
        
        // ç”Ÿæˆæ•Œäºº
        if (this.frame % 80 === 0) {
            this.enemies.push({
                x: Math.random() * 760,
                y: -40,
                width: 40,
                height: 40,
                speed: 1 + Math.random(),
                health: 2
            });
        }
        
        // æ›´æ–°æ•Œäºº
        for (let i = this.enemies.length - 1; i >= 0; i--) {
            this.enemies[i].y += this.enemies[i].speed;
            
            // æ•Œäººåˆ°è¾¾åŸºåœ°
            if (this.enemies[i].y > 460) {
                this.base.health -= 10;
                this.enemies.splice(i, 1);
                
                if (this.base.health <= 0) {
                    this.gameOver();
                    return;
                }
                continue;
            }
            
            // å­å¼¹å‡»ä¸­æ•Œäºº
            for (let j = this.bullets.length - 1; j >= 0; j--) {
                if (this.checkCollision(this.bullets[j], this.enemies[i])) {
                    this.bullets.splice(j, 1);
                    this.enemies[i].health--;
                    
                    if (this.enemies[i].health <= 0) {
                        this.enemies.splice(i, 1);
                        this.score += 10;
                        document.getElementById('gameScore').textContent = this.score;
                    }
                    break;
                }
            }
        }
    }
    
    render() {
        // èƒŒæ™¯
        this.ctx.fillStyle = '#1a1a2e';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç½‘æ ¼
        this.ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        this.ctx.lineWidth = 1;
        for (let x = 0; x < 800; x += 40) {
            this.ctx.beginPath();
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, 500);
            this.ctx.stroke();
        }
        for (let y = 0; y < 500; y += 40) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(800, y);
            this.ctx.stroke();
        }
        
        // åŸºåœ°
        this.ctx.fillStyle = '#10b981';
        this.ctx.fillRect(this.base.x, this.base.y, this.base.width, this.base.height);
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = '14px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(`åŸºåœ° ${this.base.health}%`, this.base.x + 40, this.base.y + 25);
        
        // å¦å…‹
        this.ctx.save();
        this.ctx.translate(this.tank.x + 20, this.tank.y + 20);
        this.ctx.rotate(this.tank.angle);
        
        // ç‚®ç®¡
        this.ctx.fillStyle = '#06b6d4';
        this.ctx.fillRect(15, -3, 20, 6);
        
        // è½¦èº«
        this.ctx.fillStyle = '#0ea5e9';
        this.ctx.fillRect(-20, -15, 40, 30);
        
        // ç‚®å¡”
        this.ctx.fillStyle = '#38bdf8';
        this.ctx.beginPath();
        this.ctx.arc(0, 0, 12, 0, Math.PI * 2);
        this.ctx.fill();
        
        this.ctx.restore();
        
        // å­å¼¹
        this.ctx.fillStyle = '#fbbf24';
        this.bullets.forEach(bullet => {
            this.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        });
        
        // æ•Œäºº
        this.ctx.fillStyle = '#ef4444';
        this.enemies.forEach(enemy => {
            this.ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            
            // ç”Ÿå‘½å€¼
            this.ctx.fillStyle = '#ffffff';
            this.ctx.font = '12px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(enemy.health, enemy.x + 20, enemy.y + 25);
            this.ctx.fillStyle = '#ef4444';
        });
        
        // æç¤º
        if (!this.running) {
            this.ctx.fillStyle = 'rgba(255,255,255,0.9)';
            this.ctx.font = '20px "Noto Sans SC"';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('æ–¹å‘é”®ç§»åŠ¨ï¼Œç©ºæ ¼é”®å°„å‡»', 400, 250);
            this.ctx.fillText('å®ˆæŠ¤ä½ çš„åŸºåœ°ï¼', 400, 280);
        }
    }
    
    checkCollision(a, b) {
        return a.x < b.x + b.width &&
               a.x + a.width > b.x &&
               a.y < b.y + b.height &&
               a.y + a.height > b.y;
    }
    
    gameOver() {
        this.stop();
        setTimeout(() => {
            alert(`æ¸¸æˆç»“æŸï¼\næ‘§æ¯æ•Œäººï¼š${this.score / 10}ä¸ª\næœ€ç»ˆå¾—åˆ†ï¼š${this.score}`);
            document.getElementById('gameOverlay').classList.remove('hidden');
        }, 100);
    }
}

// ==================== å·¥å…·å‡½æ•° ====================
function showAbout() {
    alert(`ğŸ® å…³äº AI PlayLab

AI PlayLab æ˜¯ä¸€ä¸ªåˆ›æ–°çš„æ¸¸æˆåˆ›ä½œå¹³å°ï¼Œè®©æ¯ä¸ªäººéƒ½èƒ½è½»æ¾åˆ›å»ºå±äºè‡ªå·±çš„æ¸¸æˆã€‚

âœ¨ æ ¸å¿ƒç‰¹è‰²ï¼š
â€¢ è‡ªç„¶è¯­è¨€æè¿°ï¼ŒAIä¸€é”®ç”Ÿæˆ
â€¢ æ”¯æŒå¤šç§AIå¼•æ“ï¼ˆPlayLab AIã€GPT-4ã€Claudeï¼‰
â€¢ å®æ—¶æ¸¸æˆé¢„è§ˆå’Œè¯•ç©
â€¢ ç¤¾åŒºäº’åŠ¨ï¼ˆç‚¹èµã€è¯„è®ºã€åˆ†äº«ï¼‰
â€¢ RemixäºŒåˆ›ï¼Œæ¿€å‘æ— é™åˆ›æ„
â€¢ åˆ›ä½œè€…æ”¶ç›Šåˆ†æˆ

ğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š
1. ç‚¹å‡»"åˆ›ä½œæ¸¸æˆ"
2. æè¿°ä½ çš„æ¸¸æˆåˆ›æ„
3. é€‰æ‹©AIå¼•æ“
4. ç­‰å¾…ç”Ÿæˆ
5. ç«‹å³è¯•ç©å’Œåˆ†äº«

å¿«æ¥é‡Šæ”¾ä½ çš„åˆ›æ„å§ï¼`);
}
